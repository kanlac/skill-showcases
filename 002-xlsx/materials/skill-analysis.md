# xlsx Skill 分析

## 1. 这个 Skill 做了什么？

这是一个**全面的电子表格处理技能**，让 Claude 能够：

| 功能 | 说明 |
|------|------|
| 创建新文件 | 创建带公式和格式的 .xlsx/.xlsm 文件 |
| 读取分析 | 用 pandas 进行数据分析和可视化 |
| 编辑修改 | 修改现有文件同时保留原有公式 |
| 公式重算 | 使用 LibreOffice 重新计算公式值 |

---

## 2. 为什么要用 LibreOffice？

这是**技术限制导致的必然选择**：

**问题根源**：Python 的 `openpyxl` 库可以读写 Excel 文件，但它有一个关键缺陷——**只能存储公式字符串，不会计算公式的实际结果值**。

举个例子：
```python
sheet['B10'] = '=SUM(A1:A9)'  # openpyxl 写入的只是这个字符串
# Excel 打开后会看到公式，但单元格显示的"值"可能是空的或旧的
```

**解决方案**：利用 LibreOffice 的无头模式 (headless mode) 作为"计算引擎"：
- `recalc.py` 脚本会调用 LibreOffice
- LibreOffice 打开文件 → 执行 `calculateAll()` → 保存 → 关闭
- 这样所有公式的计算值都会被正确写入文件

简单说：**openpyxl 负责"写公式"，LibreOffice 负责"算结果"**。

---

## 3. 总结的最佳实践及其相对于什么

### (A) 相对于"在 Python 中硬编码计算结果"

**核心原则**：永远使用 Excel 公式，不要在 Python 中计算后写入固定值。

| 错误做法 | 正确做法 |
|----------|----------|
| `total = df['Sales'].sum()` → `sheet['B10'] = total` | `sheet['B10'] = '=SUM(B2:B9)'` |

**为什么**：硬编码的值无法随源数据变化而更新，失去了电子表格的动态特性。

---

### (B) 相对于金融建模行业标准

这是投行/金融领域的通用规范：

**颜色编码标准**：
- 蓝色文字 (RGB: 0,0,255)：硬编码输入值（用户可修改的假设）
- 黑色文字 (RGB: 0,0,0)：所有公式和计算
- 绿色文字 (RGB: 0,128,0)：来自同一工作簿其他表的链接
- 红色文字 (RGB: 255,0,0)：来自外部文件的链接
- 黄色背景 (RGB: 255,255,0)：需要关注的关键假设

**数字格式标准**：
- 年份用文本格式（"2024" 不是 "2,024"）
- 负数用括号 `(123)` 而非 `-123`
- 零值显示为 `-`
- 百分比一位小数 `0.0%`
- 倍数格式 `0.0x`（如 EV/EBITDA、P/E）

---

### (C) 相对于库的选择

| 场景 | 推荐库 |
|------|--------|
| 数据分析、批量操作、简单导出 | **pandas** |
| 复杂格式、公式、Excel 特有功能 | **openpyxl** |

---

### (D) 相对于常见编程错误

**公式验证清单**解决的问题：
- `#REF!`：无效的单元格引用
- `#DIV/0!`：除以零
- `#VALUE!`：数据类型错误
- `#NAME?`：无法识别的函数名

**常见陷阱**：
- Excel 是 1-indexed（DataFrame 第5行 = Excel 第6行）
- 远列号容易算错（第64列是 BL 不是 BK）
- `data_only=True` 打开后保存会**永久丢失公式**

---

## 总结

这个 skill 本质上是一套**"让 AI 正确操作 Excel 的指南"**：
1. 解决了 openpyxl 不能计算公式的技术问题（用 LibreOffice）
2. 确保生成的文件符合金融行业的专业标准
3. 避免了 AI 可能犯的常见错误（如硬编码计算值）
