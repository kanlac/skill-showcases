# 案例1: 财务报表分析与建模

## 背景场景

你是一名财务分析师，公司需要为一家制造业企业建立完整的三表财务模型，并进行财务比率分析。现有的模板文件包含了该企业 2022-2024 年的历史财务数据，需要补充 2025-2026 年的预测数据，并建立一套完整的财务分析框架。

## 当前状态

模板文件 `financial_model_template.xlsx` 包含三张表：

### 1. 损益表 (Income Statement)
- 包含 2022-2024 年历史数据
- 已有基础公式：毛利、营业利润、税前利润、所得税、净利润
- 2025-2026 年数据缺失

### 2. 资产负债表 (Balance Sheet)
- 包含 2022-2024 年历史数据
- 已有跨表公式：留存收益链接到损益表净利润
- 资产负债平衡公式已建立
- 2025-2026 年数据缺失

### 3. 现金流量表 (Cash Flow Statement)
- 包含 2022-2024 年历史数据
- 已建立跨表链接和营运资本变动计算
- 2025-2026 年数据缺失

### 颜色编码说明
- **蓝色文字**：硬编码的历史数据（用户输入）
- **黑色文字**：表内公式计算结果
- **绿色文字**：跨表引用公式

## 任务要求

### 第一部分：完成财务预测（难度：★★★☆☆）

1. **补充 2025-2026 年预测假设**
   - 在损益表中添加一个新的 sheet 命名为 "预测假设"
   - 建立以下关键假设（用蓝色文字标记）：
     - 营业收入增长率（2025: 18%, 2026: 15%）
     - 毛利率目标（维持在 44%）
     - 各项费用占收入比例
     - 资本支出占收入比例（8%）
     - 借款增长率（0%，维持现有规模）

2. **使用公式完成预测**
   - 所有预测数据必须使用 Excel 公式，引用"预测假设"表
   - 不允许硬编码任何计算结果
   - 确保三张表之间的勾稽关系正确

### 第二部分：建立财务比率分析（难度：★★★★☆）

创建新的 sheet 命名为 "财务分析"，计算以下指标：

#### 盈利能力指标
1. 毛利率 = 毛利 / 营业收入
2. 营业利润率 = 营业利润 / 营业收入
3. 净利率 = 净利润 / 营业收入
4. ROE（净资产收益率）= 净利润 / 平均股东权益
5. ROA（总资产收益率）= 净利润 / 平均总资产

#### 偿债能力指标
1. 流动比率 = 流动资产 / 流动负债
2. 速动比率 = (流动资产 - 存货) / 流动负债
3. 资产负债率 = 总负债 / 总资产
4. 利息保障倍数 = EBIT / 财务费用

#### 营运能力指标
1. 应收账款周转天数 = 平均应收账款 / (营业收入/365)
2. 存货周转天数 = 平均存货 / (营业成本/365)
3. 应付账款周转天数 = 平均应付账款 / (营业成本/365)
4. 现金周转周期 = 应收账款周转天数 + 存货周转天数 - 应付账款周转天数

#### 增长能力指标
1. 营业收入同比增长率
2. 净利润同比增长率

### 第三部分：数据可视化与格式化（难度：★★★☆☆）

1. **应用金融行业颜色编码标准**
   - 确保所有公式为黑色文字
   - 所有硬编码输入为蓝色文字
   - 所有跨表引用为绿色文字

2. **数字格式标准化**
   - 所有金额使用千分位分隔符
   - 百分比显示一位小数（如 12.5%）
   - 倍数格式使用 0.0x（如 1.5x）
   - 负数使用括号表示（如 (1,234)）

3. **条件格式化**
   - 在财务分析表中，对关键指标设置条件格式：
     - 净利率 < 10%：红色背景
     - 净利率 10%-15%：黄色背景
     - 净利率 > 15%：绿色背景
   - 资产负债率 > 60%：橙色背景警示

4. **创建仪表板**
   - 创建新的 sheet 命名为 "Dashboard"
   - 使用 SPARKLINE 或者条件格式展示：
     - 5年营业收入趋势
     - 5年净利润趋势
     - 关键财务比率的趋势（ROE, 净利率, 资产负债率）

### 第四部分：数据验证（难度：★★★★★）

1. **建立核对机制**
   - 确保资产负债表平衡（总资产 = 负债与权益总计）
   - 确保现金流量表期末现金 = 资产负债表现金
   - 添加验证公式，当不平衡时显示 "ERROR"

2. **公式审计**
   - 检查所有公式单元格，确保没有 #REF!、#DIV/0!、#VALUE! 等错误
   - 确保所有预测年份都使用了公式而非硬编码

## 预期结果

完成后的文件应该包含：

1. ✅ **6个工作表**
   - 损益表（含完整5年数据）
   - 资产负债表（含完整5年数据）
   - 现金流量表（含完整5年数据）
   - 预测假设（清晰的假设输入区域）
   - 财务分析（完整的财务比率计算）
   - Dashboard（可视化仪表板）

2. ✅ **正确的公式体系**
   - 所有预测数据来源于"预测假设"表
   - 三张财务报表之间勾稽关系正确
   - 所有计算使用 Excel 公式，无硬编码值

3. ✅ **专业的格式化**
   - 符合金融行业颜色编码标准
   - 数字格式专业且一致
   - 关键指标有条件格式提醒

4. ✅ **完整的验证机制**
   - 资产负债表平衡检查通过
   - 现金勾稽检查通过
   - 无公式错误

5. ✅ **使用 LibreOffice recalculate**
   - 所有公式值已正确计算并缓存
   - 文件可以直接在任何 Excel 查看器中正确显示

## 技能考察点

这个案例能够测试 AI 工具的以下能力：

### 初级能力（必须掌握）
- [ ] 读取和理解现有 Excel 文件结构
- [ ] 使用 openpyxl 写入基础公式
- [ ] 正确处理单元格引用（相对引用 vs 绝对引用）
- [ ] 基础的数字格式化

### 中级能力（应该掌握）
- [ ] 跨工作表公式引用
- [ ] 复杂的嵌套公式（IF、AVERAGE、SUM 等）
- [ ] 应用颜色和字体格式
- [ ] 理解财务报表之间的勾稽关系

### 高级能力（优秀表现）
- [ ] 建立结构化的假设驱动模型
- [ ] 实现动态的公式引用系统
- [ ] 正确计算平均值（如平均总资产、平均股东权益）
- [ ] 条件格式化的高级应用
- [ ] 使用 LibreOffice 进行公式重算

### 专家能力（卓越表现）
- [ ] 建立完整的数据验证和审计机制
- [ ] 实现专业级的 Excel 最佳实践
- [ ] 正确处理边界情况（除零、负数等）
- [ ] 创建可维护和可扩展的模型架构
- [ ] 理解并应用金融建模行业标准

## 常见错误预警

1. ❌ **硬编码计算结果**：直接在 Python 中计算后写入数值
   - 正确做法：写入 Excel 公式字符串

2. ❌ **忘记行列索引差异**：DataFrame 行索引 vs Excel 行号
   - Excel 是 1-indexed，且有表头占位

3. ❌ **跨表引用语法错误**：`=Sheet1!A1` 而非 `=Sheet1.A1`

4. ❌ **平均值计算错误**：ROE 需要使用期初期末平均股东权益
   - 2024 ROE = 2024净利润 / ((2023权益+2024权益)/2)

5. ❌ **忘记使用 LibreOffice recalculate**
   - 导致公式单元格值为空或错误

6. ❌ **条件格式范围错误**：应用到公式单元格而非值单元格

## 评估标准

| 维度 | 权重 | 评分标准 |
|------|------|----------|
| 功能完整性 | 30% | 是否完成所有要求的功能 |
| 公式正确性 | 25% | 公式逻辑是否正确，结果是否准确 |
| 代码质量 | 20% | 是否遵循最佳实践，代码可读性 |
| 格式专业度 | 15% | 是否符合金融行业标准 |
| 错误处理 | 10% | 是否有数据验证和错误检查机制 |

## 参考资源

- 金融建模颜色编码标准：参见 `materials/skill-analysis.md` 第52-60行
- LibreOffice recalculate 概念：参见 `materials/why.md`
- openpyxl 公式写入：使用字符串形式 `cell.value = '=SUM(A1:A10)'`
